# Using Cloud Shell or via ssh running "gcloud alpha cloud-shell ssh"
gcloud config set compute/zone europe-west1-b

# Creation of dedicated VPC
gcloud compute networks create jenkins

# Cluster creation
 # storage-rw to access Google Container inside Google Cloud Storage
 # projecthosting to access Google Cloud Source Repositories
gcloud container clusters create jenkins-cd --network jenkins --machine-type n1-standard-2 --num-nodes 2 --scopes "https://www.googleapis.com/auth/projecthosting,storage-rw,cloud-platform"
# Auto-configure cluster correctly
gcloud container clusters get-credentials jenkins-cd

# Add our GCP account as cluster administrator through a new binding
kubectl create clusterrolebinding cluster-admin-binding --clusterrole=cluster-admin --user=$(gcloud config get-value account)

# Creation of a service account in the kube-system namespace
kubectl create -f jenkins-installation/serviceaccount.yaml
# Add the new service account for Tiller (the Helm server agent) to have the role of cluster admin
kubectl create -f jenkins-installation/rolebinding.yaml

# Assuming that we have Helm client installed locally, we initialize Heml client to work with the new service account, creating some folders locally
./helm init --service-account=tiller
./helm update

# Installs Jenkins on the cluster with a Helm chart taken from
# https://github.com/helm/charts/tree/master/stable/jenkins (with the name "cd") that allows to configure Jenkins from the command line or via yaml file "jenkins-conf"
# We will use our own config file for Jenkins and
# Inside the Chart.yaml we can see the reference to https://github.com/jenkinsci/jenkins where the Jenkins image is hosted
./helm install -n cd stable/jenkins -f jenkins-installation/jenkins-conf.yaml --version 0.25.0 --wait

# If you experience some credentials problems with the error message "Error: the server has asked for the client to provide credentials" try reinstalling tiller doing:
rm -rf ~/.helm/
./helm reset --force
./helm init --service-account=tiller
./helm update

# Now we can access to Jenkins that has just been installed, for example, redirecting
export POD_NAME=$(kubectl get pods -o jsonpath="{.items[0].metadata.name}")
kubectl port-forward $POD_NAME 8080:8080 >> /dev/null &

# And use the autogenerated password generated by the Chart installation
printf $(kubectl get secret cd-jenkins -o jsonpath="{.data.jenkins-admin-password}" | base64 --decode);echo

# kubectl get services


